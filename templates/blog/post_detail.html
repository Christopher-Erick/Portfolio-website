{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }} - Christopher Erick Otieno{% endblock %}

{% block description %}{{ post.excerpt|default:post.title }}{% endblock %}

{% block content %}
<!-- Post Hero Section -->
<section id="post-hero" class="hero">
    <div class="container">
        <div class="hero-content fade-in">
            <h1 class="hero-title">{{ post.title }}</h1>
            <p class="hero-subtitle">{{ post.category.name }}</p>
            <div class="post-meta">
                <span><i class="fas fa-calendar"></i> {{ post.published_at|date:"F d, Y" }}</span>
                <span><i class="fas fa-clock"></i> {{ post.reading_time }} min read</span>
                <span><i class="fas fa-user"></i> {{ post.author.get_full_name|default:post.author.username }}</span>
                <span><i class="fas fa-eye"></i> <span id="view-count">{{ post.total_views }}</span> views</span>
            </div>
        </div>
    </div>
</section>

<!-- Post Content Section -->
<section id="post-content" class="section">
    <div class="container">
        <div class="main-content-grid">
            <div class="content-column">
                <article class="post-article">
                    {% if post.featured_image %}
                    <div class="post-featured-image">
                        <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" class="responsive-img">
                    </div>
                    {% endif %}
                    
                    <div class="post-content">
                        {{ post.content|safe }}
                    </div>
                    
                    <!-- Feedback Section -->
                    <div class="post-feedback">
                        <h5>Did you find this post helpful?</h5>
                        <div class="feedback-buttons">
                            <button id="like-btn" class="btn btn-outline-success" data-like="true">
                                <i class="fas fa-thumbs-up"></i> 
                                <span id="like-count">{{ post.total_likes }}</span>
                            </button>
                            <button id="dislike-btn" class="btn btn-outline-danger" data-like="false">
                                <i class="fas fa-thumbs-down"></i> 
                                <span id="dislike-count">{{ post.total_dislikes }}</span>
                            </button>
                        </div>
                        <div id="feedback-message" class="feedback-message"></div>
                    </div>
                    
                    {% if post.tags.all %}
                    <div class="post-tags">
                        <h5>Tags:</h5>
                        {% for tag in post.tags.all %}
                        <span class="tag">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </article>
            </div>
            
            <div class="sidebar-column">
                <div class="sidebar">
                    {% if related_posts %}
                    <div class="sidebar-widget">
                        <h4>Related Posts</h4>
                        {% for related_post in related_posts %}
                        <div class="related-post">
                            <h6><a href="{{ related_post.get_absolute_url }}">{{ related_post.title }}</a></h6>
                            <small>{{ related_post.published_at|date:"M d, Y" }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
    #post-hero {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        min-height: 40vh;
        display: flex;
        align-items: center;
        width: 100%;
    }
    
    .main-content-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        width: 100%;
    }
    
    @media (min-width: 768px) {
        .main-content-grid {
            grid-template-columns: 2fr 1fr;
        }
    }
    
    @media (min-width: 1200px) {
        .main-content-grid {
            grid-template-columns: 2.5fr 1fr;
        }
    }
    
    .content-column {
        min-width: 0; /* Allow content to shrink */
    }
    
    .sidebar-column {
        min-width: 0; /* Allow content to shrink */
    }
    
    .post-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        margin-top: 1rem;
        opacity: 0.9;
    }
    
    .post-featured-image {
        margin-bottom: 2rem;
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        width: 100%;
    }
    
    .responsive-img {
        width: 100%;
        height: auto;
        display: block;
    }
    
    .post-content {
        line-height: 1.8;
        font-size: 1.1rem;
    }
    
    .post-feedback {
        margin: 2rem 0;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border-radius: var(--border-radius-lg);
        text-align: center;
    }
    
    .feedback-buttons {
        margin: 1rem 0;
        display: flex;
        justify-content: center;
        gap: 1rem;
    }
    
    .feedback-buttons button {
        border-width: 2px;
        min-width: 120px;
    }
    
    .feedback-message {
        margin-top: 1rem;
        min-height: 1.5rem;
    }
    
    .post-tags {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .tag {
        display: inline-block;
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: var(--border-radius);
        font-size: 0.9rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .sidebar-widget {
        background: var(--bg-primary);
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        border: 1px solid rgba(0, 0, 0, 0.1);
        width: 100%;
        box-sizing: border-box; /* Include padding in width calculation */
    }
    
    [data-theme="dark"] .sidebar-widget {
        background: #2a2a2a;
        border-color: rgba(255, 255, 255, 0.1);
    }
    
    [data-theme="dark"] .post-tags {
        border-top-color: rgba(255, 255, 255, 0.1);
    }
    
    [data-theme="dark"] .tag {
        background: #00ff7f;
        color: #1a1a1a;
    }
    
    [data-theme="dark"] .related-post {
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }
    
    .related-post {
        padding: 1rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        word-wrap: break-word; /* Prevent long titles from causing overflow */
        overflow-wrap: break-word; /* Modern property for word wrapping */
    }
    
    .related-post:last-child {
        border-bottom: none;
    }
    
    .related-post a {
        color: var(--text-primary);
        text-decoration: none;
        word-wrap: break-word; /* Prevent long titles from causing overflow */
        overflow-wrap: break-word; /* Modern property for word wrapping */
    }
    
    .related-post a:hover {
        color: var(--primary-color);
    }
    
    /* Ensure proper sizing on larger screens */
    @media (min-width: 1400px) {
        .container {
            max-width: 1320px;
        }
        
        .post-meta {
            font-size: 1.1rem;
        }
        
        .post-content {
            font-size: 1.2rem;
        }
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .post-meta {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }
        
        .feedback-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .feedback-buttons button {
            width: 100%;
            max-width: 200px;
            margin-bottom: 0.5rem;
        }
        
        .post-tags {
            text-align: center;
        }
        
        .tag {
            display: inline-block;
            margin: 0.25rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Like/Dislike functionality
        const likeBtn = document.getElementById('like-btn');
        const dislikeBtn = document.getElementById('dislike-btn');
        const likeCount = document.getElementById('like-count');
        const dislikeCount = document.getElementById('dislike-count');
        const feedbackMessage = document.getElementById('feedback-message');
        const viewCount = document.getElementById('view-count');
        
        // Get CSRF token from window object
        const csrftoken = window.csrfToken;
        
        // Add click event listeners
        if (likeBtn) {
            likeBtn.addEventListener('click', function() {
                sendFeedback(true);
            });
        }
        
        if (dislikeBtn) {
            dislikeBtn.addEventListener('click', function() {
                sendFeedback(false);
            });
        }
        
        function sendFeedback(isLike) {
            // Show loading state
            const originalLikeText = likeBtn ? likeBtn.innerHTML : '';
            const originalDislikeText = dislikeBtn ? dislikeBtn.innerHTML : '';
            
            if (likeBtn) likeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            if (dislikeBtn) dislikeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            fetch('{% url "blog:post_like" post.slug %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    is_like: isLike
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update counts
                    if (likeCount) likeCount.textContent = data.likes;
                    if (dislikeCount) dislikeCount.textContent = data.dislikes;
                    
                    // Show message
                    if (feedbackMessage) {
                        feedbackMessage.textContent = data.message;
                        feedbackMessage.className = 'feedback-message text-success';
                    }
                    
                    // Clear message after 3 seconds
                    setTimeout(() => {
                        if (feedbackMessage) {
                            feedbackMessage.textContent = '';
                            feedbackMessage.className = 'feedback-message';
                        }
                    }, 3000);
                } else {
                    if (feedbackMessage) {
                        feedbackMessage.textContent = data.message || 'An error occurred. Please try again.';
                        feedbackMessage.className = 'feedback-message text-danger';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (feedbackMessage) {
                    feedbackMessage.textContent = 'An error occurred. Please try again.';
                    feedbackMessage.className = 'feedback-message text-danger';
                }
            })
            .finally(() => {
                // Restore button text
                if (likeBtn) likeBtn.innerHTML = originalLikeText;
                if (dislikeBtn) dislikeBtn.innerHTML = originalDislikeText;
            });
        }
    });
</script>
{% endblock %}